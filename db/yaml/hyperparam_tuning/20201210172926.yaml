entrypoint: main
arguments:
  parameters:
    - name: dataset
      value: https://github.com/onepanelio/templates/releases/download/v0.2.0/patch_medical_valid_subset10k.zip
      displayName: Dataset path
      hint: Path to annotated data
      visibility: public
    - name: num-classes
      displayName: Number of classes
      visibility: public
      value: '2'
      hint: 'Number of classes in a dataset'
    - name: test-split
      displayName: Percentage of images to use for testing
      visibility: public
      value: '20'
      hint: 'Percentage of data to be used for test set'
    - name: searchspace-config
      type: textarea.textarea
      displayName: Search space for hyperparameter tuning
      value: |-
        model_type=alexnet              # any model type supported by torchvision
        batch_size_list=16,32,64,128    # batch sizes for hyperparameter tuner
        lr_list=0.0001,0.001,0.01,0.1   # learning rates for hyperparameter tuner
        momentum_range=0,1              # range for momentum for hyperparameter tuner
        epochs=2                        # epochs to train each model for
        tuner=TPE                       # any tuner supprted by NNI
        max_trial_num=10                # max number of trials to run
      hint: 'Define parameters for hyperparameter tuning'
    - displayName: Node pool
      hint: Name of node pool or group to run this workflow task
      type: select.select
      visibility: public
      name: sys-node-pool
      value: n1-standard-4
      required: true
volumeClaimTemplates:
  - metadata:
      name: hyperparamtuning-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 200Gi
  - metadata:
      name: hyperparamtuning-output
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 200Gi
  - metadata:
      name: preprocess-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 200Gi
  - metadata:
      name: preprocess-output
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 200Gi
templates:
  - name: main
    dag:
      tasks:
        - name: process-data
          template: process-data
        - name: hyperparameter-tuning
          arguments:
            artifacts:
              - name: processed-data
                from: "{{tasks.process-data.outputs.artifacts.processed-data}}"
          template: hyperop
          dependencies: [process-data]
  - name: hyperop
    inputs:
      artifacts:
        - name: processed-data
          path: /mnt/data/datasets/processed_data.zip
    outputs:
      artifacts:
        - name: data
          path: /mnt/output
          optional: true
          archive:
            none: {}
    container:
      image: onepanel/nni:1.0.2
      command: [sh,-c]
      args:
        - |
          mv /mnt/data/datasets/processed_data.zip ./ && \
          unzip processed_data.zip -d /mnt/data/datasets/ && \
          git clone --single-branch --branch fix/config_param https://github.com/onepanelio/nni.git && \
          cd nni/ && \
          python3 examples/trials/pytorch-classifier/create_yaml.py \
              --config="{{workflow.parameters.searchspace-config}}" \
              --num_classes="{{workflow.parameters.num-classes}}" && \
          nnictl create --config examples/trials/pytorch-classifier/config.yml --port 8089 --foreground
      workingDir: /mnt
      volumeMounts:
        - name: hyperparamtuning-data
          mountPath: /mnt/data
        - name: hyperparamtuning-output
          mountPath: /mnt/output
    nodeSelector:
      beta.kubernetes.io/instance-type: '{{workflow.parameters.sys-node-pool}}'
    sidecars:
      - name: nni-hyperparamopt-ui
        image: 'onepanel/nni-proxy:0.0.1'
        env:
          - name: ONEPANEL_INTERACTIVE_SIDECAR
            value: 'true'
        ports:
          - containerPort: 8089
            name: nni
  - name: process-data
    inputs:
      artifacts:
        - name: data
          path: /mnt/data/dataset.zip
          http:
            url: '{{workflow.parameters.dataset}}'
    outputs:
      artifacts:
        - name: processed-data
          path: /mnt/output/processed_data.zip
          optional: true
    container:
      image: pytorch/pytorch:latest
      command: [sh,-c]
      args:
        - |
          apt-get update && \
          apt-get install -y gcc g++ git unzip zip && \
          python3 -m pip install setuptools && \
          ls /mnt/data && \
          cd /mnt/data/ && \
          unzip dataset.zip && \
          rm -f dataset.zip && \
          cd /mnt && \
          git clone --single-branch --branch fix/config_param https://github.com/onepanelio/nni.git && \
          cd nni/ && \
          python3 prepare_data.py --data_dir="./processed_data" \
                                  --test_split="{{workflow.parameters.test-split}}" \
                                  --image_dir="/mnt/data" \
                                  --skip="true" && \
          zip -r /mnt/output/processed_data.zip ./processed_data
      workingDir: /mnt
      volumeMounts:
        - name: preprocess-data
          mountPath: /mnt/data
        - name: preprocess-output
          mountPath: /mnt/output
    nodeSelector:
      beta.kubernetes.io/instance-type: '{{workflow.parameters.sys-node-pool}}'